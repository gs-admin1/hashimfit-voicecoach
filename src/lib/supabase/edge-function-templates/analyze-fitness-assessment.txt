
// Supabase Edge Function to analyze fitness assessment and generate personalized plans
// Deploy this code to a Supabase Edge Function named 'analyze-fitness-assessment'

import { serve } from 'https://deno.land/std@0.177.0/http/server.ts'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // Get the request body
    let requestData;
    try {
      requestData = await req.json();
      console.log("Received request body:", JSON.stringify(requestData, null, 2));
    } catch (parseError) {
      console.error("Failed to parse request body:", parseError);
      return new Response(
        JSON.stringify({ error: 'Invalid JSON in request body' }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 400 }
      );
    }
    
    const { user_id, assessment } = requestData;
    
    console.log("Processing assessment request for user:", user_id);
    
    if (!user_id || !assessment) {
      console.error("Missing required fields in request:", { user_id, assessment: !!assessment });
      return new Response(
        JSON.stringify({ error: 'Missing required fields: user_id or assessment data' }),
        { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 400 }
      )
    }

    // Generate a mock fitness plan since the OpenAI integration is failing
    // This ensures users can continue using the app while we debug the OpenAI integration
    const workoutPlan = generateMockResponse();
    
    return new Response(
      JSON.stringify(workoutPlan),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 200 }
    )
  } catch (error) {
    console.error('General error:', error);
    return new Response(
      JSON.stringify({ 
        error: error.message, 
        details: 'An unexpected error occurred while processing the fitness assessment'
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' }, status: 500 }
    )
  }
})

// Generate a mock response for testing/development
function generateMockResponse() {
  return {
    workout_plans: [
      {
        day: "Monday",
        title: "Upper Body Strength",
        description: "Focus on building upper body strength",
        category: "strength",
        exercises: [
          {
            name: "Bench Press",
            sets: 3,
            reps: "8-10",
            weight: "60kg",
            rest_time: 90
          },
          {
            name: "Shoulder Press",
            sets: 3,
            reps: "8-10",
            weight: "40kg",
            rest_time: 90
          },
          {
            name: "Bicep Curls",
            sets: 3,
            reps: "10-12",
            weight: "15kg",
            rest_time: 60
          }
        ]
      },
      {
        day: "Thursday",
        title: "Lower Body Power",
        description: "Focus on building lower body strength and power",
        category: "strength",
        exercises: [
          {
            name: "Squats",
            sets: 4,
            reps: "6-8",
            weight: "80kg",
            rest_time: 120
          },
          {
            name: "Leg Press",
            sets: 3,
            reps: "8-10",
            weight: "120kg",
            rest_time: 90
          },
          {
            name: "Leg Curls",
            sets: 3,
            reps: "10-12",
            weight: "40kg",
            rest_time: 60
          }
        ]
      }
    ],
    nutrition_plan: {
      daily_calories: 2200,
      protein_g: 170,
      carbs_g: 50,
      fat_g: 160,
      diet_type: "standard",
      meals: [
        {
          meal_type: "breakfast",
          meal_title: "High Protein Breakfast",
          description: "Eggs and whole grain toast",
          calories: 550,
          protein_g: 35,
          carbs_g: 8,
          fat_g: 45
        },
        {
          meal_type: "lunch",
          meal_title: "Grilled Chicken Salad",
          description: "Grilled chicken with mixed greens",
          calories: 650,
          protein_g: 45,
          carbs_g: 12,
          fat_g: 48
        },
        {
          meal_type: "dinner",
          meal_title: "Baked Salmon",
          description: "Baked salmon with vegetables",
          calories: 750,
          protein_g: 60,
          carbs_g: 15,
          fat_g: 52
        },
        {
          meal_type: "snack",
          meal_title: "Protein Shake",
          description: "Protein shake with almond milk",
          calories: 250,
          protein_g: 20,
          carbs_g: 5,
          fat_g: 15
        }
      ]
    },
    recommendations: [
      "Stay hydrated with plenty of water throughout the day",
      "Ensure you're getting 7-8 hours of quality sleep",
      "Focus on progressive overload in your strength training",
      "Include a protein source with every meal",
      "Track your progress weekly"
    ]
  };
}
